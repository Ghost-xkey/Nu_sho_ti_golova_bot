import requests
import json
import random
import logging
import os
from typing import Optional, List
from config import YANDEX_API_KEY, YANDEX_FOLDER_ID, ALLOW_PROFANITY, PROFANITY_LEVEL

class YandexGPT:
    def __init__(self):
        # –ë–µ—Ä—ë–º –∫–ª—é—á–∏ –∏–∑ ENV —Å –∑–∞–ø–∞—Å–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º –∏–∑ config
        self.api_key = os.getenv("YANDEX_API_KEY", YANDEX_API_KEY)
        self.folder_id = os.getenv("YANDEX_FOLDER_ID", YANDEX_FOLDER_ID)
        self.base_url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
        self.chat_history = {}  # –•—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
        self.last_topic = {}    # chat_id -> {'topic': str, 'ts': unix}
        
    def get_headers(self):
        return {
            "Authorization": f"Api-Key {self.api_key}",
            "Content-Type": "application/json"
        }
    
    def should_respond(self, message_text: str, chat_id: str) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –¥–æ–ª–∂–µ–Ω –ª–∏ AI –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        """
        message_lower = message_text.lower().strip()
        
        # –ü—Ä–æ—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã –ø–æ –∏–º–µ–Ω–∏ - –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ –Ω–∏—Ö
        simple_name_calls = ["–≥—Ä–∏—à–∞", "–±–æ—Ç"]
        if message_lower in simple_name_calls:
            return True
        
        # –ü—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –±–æ—Ç—É (–Ω–æ –Ω–µ –ø—Ä–æ—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã)
        bot_mentions = ["ai", "–∏–∏", "–ø–æ–º–æ—â–Ω–∏–∫", "–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç"]
        if any(mention in message_lower for mention in bot_mentions):
            return True
            
        # –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –∞–Ω–µ–∫–¥–æ—Ç—ã –∏ —à—É—Ç–∫–∏
        joke_triggers = ["–∞–Ω–µ–∫–¥–æ—Ç", "—à—É—Ç–∫–∞", "–ø–æ—à—É—Ç–∏", "—Ä–∞—Å—Å–º–µ—à–∏", "—á–µ—Ä–Ω—ã–π —é–º–æ—Ä", "–∂–µ—Å—Ç–∫–∞—è —à—É—Ç–∫–∞"]
        if any(trigger in message_lower for trigger in joke_triggers):
            return True
            
        # –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –º–∞—Ç –∏ –∫—Ä–µ–ø–∫—É—é –ª–µ–∫—Å–∏–∫—É
        profanity_triggers = ["–º–∞—Ç", "—Ä—É–≥–∞–π—Å—è", "–≤—ã—Ä—É–≥–∞–π—Å—è", "–∫—Ä–µ–ø–∫–æ", "–ø–ª–æ—Ö–∏–µ —Å–ª–æ–≤–∞", "–Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω–æ", "–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π", "–¥–æ—Å—Ç–∞—Ç—å", "—Ä–∞—Å—Å–º–µ—à–∏"]
        if any(trigger in message_lower for trigger in profanity_triggers):
            return True
            
        # –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
        emotional_signals = ["—Å–∫—É—á–Ω–æ", "–≥—Ä—É—Å—Ç–Ω–æ", "—É—Å—Ç–∞–ª", "–ø–ª–æ—Ö–æ", "–æ—Ç–ª–∏—á–Ω–æ", "–∫—Ä—É—Ç–æ", "–≤–µ—Å–µ–ª–æ"]
        if any(signal in message_lower for signal in emotional_signals):
            return True
            
        # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Ñ–∏–ª—å–º–æ–≤
        movie_triggers = ["—á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å", "–ø–æ—Å–æ–≤–µ—Ç—É–π —Ñ–∏–ª—å–º", "—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Ñ–∏–ª—å–º", "—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å", 
                         "—á—Ç–æ –≥–ª—è–Ω—É—Ç—å", "—Ñ–∏–ª—å–º –Ω–∞ –≤–µ—á–µ—Ä", "–∫–∏–Ω–æ –Ω–∞ –≤–µ—á–µ—Ä", "—Ö–æ—á—É –∫–∏–Ω–æ", "—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º", 
                         "–∫–æ–º–µ–¥–∏—é", "–¥—Ä–∞–º—É", "—Ç—Ä–∏–ª–ª–µ—Ä", "–±–æ–µ–≤–∏–∫", "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫—É", "—É–∂–∞—Å—ã", "–¥–µ—Ç–µ–∫—Ç–∏–≤", 
                         "–º–µ–ª–æ–¥—Ä–∞–º—É", "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", "—Ñ—ç–Ω—Ç–µ–∑–∏", "–∫—Ä–∏–º–∏–Ω–∞–ª"]
        if any(trigger in message_lower for trigger in movie_triggers):
            return True
            
        # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        support_triggers = ["–ø—Ä–æ–±–ª–µ–º—ã", "–ø–æ–º–æ—â—å", "–ø–æ–º–æ–≥–∏", "—Å–æ–≤–µ—Ç", "–ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–≥—Ä—É—Å—Ç–Ω–æ", "–ø–ª–æ—Ö–æ", 
                           "—É—Å—Ç–∞–ª", "–Ω–∞–¥–æ–µ–ª–æ", "–¥–æ—Å—Ç–∞–ª–æ", "–∑–∞–¥–æ–ª–±–∞–ª", "–≤—Å–µ –ø–ª–æ—Ö–æ"]
        if any(trigger in message_lower for trigger in support_triggers):
            return True
            
        # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –æ–±—â–µ–Ω–∏—è
        conversation_triggers = ["–ø–ª–∞–Ω—ã", "—á—Ç–æ –¥–µ–ª–∞–µ—à—å", "–∫–∞–∫ –ø—Ä–æ–≤–µ–ª", "—Ä–∞—Å—Å–∫–∞–∂–∏", "–ø–æ–¥–µ–ª–∏—Å—å", 
                               "–≤—ã—Ö–æ–¥–Ω—ã–µ", "–æ—Ç–ø—É—Å–∫", "–∫–∞–∫ –∂–∏–∑–Ω—å", "—á—Ç–æ –Ω–æ–≤–æ–≥–æ"]
        if any(trigger in message_lower for trigger in conversation_triggers):
            return True
            
        # –í–æ–ø—Ä–æ—Å—ã
        if "?" in message_text:
            return True
            
        # –°–ª—É—á–∞–π–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (10% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
        if random.random() < 0.1:
            return True
            
        return False
    
    def get_chat_context(self, chat_id: str, limit: int = 5) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
        """
        if chat_id not in self.chat_history:
            return ""
            
        recent_messages = self.chat_history[chat_id][-limit:]
        context = "\n".join([f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {msg}" for msg in recent_messages])
        return context
    
    def get_target_user_info(self, message_text: str, author_username: Optional[str]) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–∏–Ω —Ñ–∞–∫—Ç —Å—Ç—Ä–æ–≥–æ –æ —Ü–µ–ª–µ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:
        - –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å @username ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        - –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å "–ø—Ä–æ –º–µ–Ω—è" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        - –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É (–Ω–µ –ø–æ–¥–º–µ—à–∏–≤–∞–µ–º —á—É–∂–∏–µ —Ñ–∞–∫—Ç—ã)
        """
        try:
            import re
            from db import get_all_users
            
            text = (message_text or "").lower()
            target_username = None
            
            # 1) –Ø–≤–Ω–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ @username
            mention = re.search(r"@(\w+)", message_text or "")
            if mention:
                target_username = mention.group(1)
            # 2) –ó–∞–ø—Ä–æ—Å "–ø—Ä–æ –º–µ–Ω—è" ‚Äî –±–µ—Ä—ë–º –∞–≤—Ç–æ—Ä–∞
            elif any(phrase in text for phrase in [
                "–ø—Ä–æ –º–µ–Ω—è", "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –º–µ–Ω—è", "—Å–∫–∞–∂–∏ –ø—Ä–æ –º–µ–Ω—è", "—á—Ç–æ —Ç—ã –∑–Ω–∞–µ—à—å –æ–±–æ –º–Ω–µ",
                "—á—Ç–æ –∑–Ω–∞–µ—à—å –ø—Ä–æ –º–µ–Ω—è", "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ–±–æ –º–Ω–µ"
            ]):
                if author_username:
                    # author_username –ø—Ä–∏—Ö–æ–¥–∏—Ç –±–µ–∑ @ –∏–∑ handlers
                    target_username = author_username.lstrip('@')
            
            if not target_username:
                return ""
            
            users = get_all_users()
            if not users:
                return ""
            
            # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ username
            user = next((u for u in users if (u.get('username') or "").lower() == target_username.lower()), None)
            if not user:
                return ""
            
            nickname = user.get('nickname') or "–Ω–∏–∫–Ω–µ–π–º –Ω–µ —É–∫–∞–∑–∞–Ω"
            description = user.get('description') or "–æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ"
            traits = user.get('traits') or "—á–µ—Ä—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã"
            jokes_about = user.get('jokes_about') or "—à—É—Ç–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã"
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–¥–∏–Ω —Ñ–∞–∫—Ç –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            facts = [
                f"{nickname} - {description}",
                f"{nickname} –∏–∑–≤–µ—Å—Ç–µ–Ω —Ç–µ–º, —á—Ç–æ: {traits}",
                f"–ü—Ä–æ {nickname} –º–æ–∂–Ω–æ –ø–æ—à—É—Ç–∏—Ç—å: {jokes_about}"
            ]
            # –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–∫—Ç (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –æ–ø–∏—Å–∞–Ω–∏–µ ‚Üí —á–µ—Ä—Ç—ã ‚Üí —à—É—Ç–∫–∏)
            for fact in facts:
                if not any(x in fact for x in ["–Ω–µ —É–∫–∞–∑–∞–Ω", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"]):
                    return f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ —á–∞—Ç–∞ ({target_username}): {fact}"
            # –ï—Å–ª–∏ –≤—Å–µ –ø—É—Å—Ç—ã–µ ‚Äî –Ω–µ –ø–æ–¥–º–µ—à–∏–≤–∞–µ–º
            return ""
        except Exception as e:
            logging.error(f"Error getting targeted user info: {e}")
            return ""
    
    def get_recent_bot_messages(self, chat_id: str, limit: int = 3) -> list:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞"""
        try:
            # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –±–æ—Ç –º–æ–≥ –æ—Ç–≤–µ—á–∞—Ç—å
            if chat_id in self.chat_history and len(self.chat_history[chat_id]) > 0:
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å –æ–¥–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –¥–∏–∞–ª–æ–≥ –±—ã–ª
                return [{"message": "bot_was_here", "is_bot": True}]
            return []
        except Exception as e:
            logging.error(f"Error getting recent bot messages: {e}")
            return []
    
    def check_repeated_message(self, chat_id: str, message_text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º—Å—è"""
        try:
            if chat_id not in self.chat_history:
                return False
            
            chat_history = self.chat_history[chat_id]
            if len(chat_history) < 2:
                return False
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
            recent_messages = chat_history[-3:]
            message_count = sum(1 for msg in recent_messages if msg.strip() == message_text.strip())
            
            # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 2+ —Ä–∞–∑–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
            return message_count >= 2
        except Exception as e:
            logging.error(f"Error checking repeated message: {e}")
            return False
    
    def add_to_history(self, chat_id: str, message: str):
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
        """
        if chat_id not in self.chat_history:
            self.chat_history[chat_id] = []
            
        self.chat_history[chat_id].append(message)
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 20 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        if len(self.chat_history[chat_id]) > 20:
            self.chat_history[chat_id] = self.chat_history[chat_id][-20:]

    def update_topic(self, chat_id: str, message_text: str):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –±–µ—Å–µ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            import time
            key_phrases = ["–ø—Ä–æ –º–µ–Ω—è", "—Ñ–∏–ª—å–º", "–∫–∏–Ω–æ", "—Ä–∞–±–æ—Ç–∞", "—É—á–µ–±–∞", "–ø–æ–≥–æ–¥–∞", "–ø–ª–∞–Ω—ã"]
            lowered = (message_text or "").lower()
            if any(k in lowered for k in key_phrases) or len(message_text) > 40:
                self.last_topic[chat_id] = {
                    'topic': message_text.strip()[:200],
                    'ts': int(time.time())
                }
        except Exception as e:
            logging.error(f"Error updating topic: {e}")

    def get_active_topic(self, chat_id: str) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Ç–µ–º—É, –µ—Å–ª–∏ –æ–Ω–∞ –º–æ–ª–æ–∂–µ 15 –º–∏–Ω—É—Ç"""
        import time
        info = self.last_topic.get(chat_id)
        if not info:
            return ""
        if time.time() - info['ts'] <= 15 * 60:
            return info['topic']
        return ""
    
    def generate_response(self, message_text: str, chat_id: str, username: str = None) -> Optional[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç AI –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        try:
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.add_to_history(chat_id, message_text)
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            context = self.get_chat_context(chat_id)
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏ —á–∏—Ç–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç–µ–º—É (–¥–∏–∞–ª–æ–≥–æ–≤–∞—è –∏–Ω–µ—Ä—Ü–∏—è)
            self.update_topic(chat_id, message_text)
            active_topic = self.get_active_topic(chat_id)
            
            # –¢–∞—Ä–≥–µ—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ –ø—Ä–æ—Å—è—Ç)
            users_info = self.get_target_user_info(message_text, username)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã –º–∞—Ç–∞
            message_lower = message_text.lower()
            profanity_triggers = ["–º–∞—Ç", "—Ä—É–≥–∞–π—Å—è", "–≤—ã—Ä—É–≥–∞–π—Å—è", "–∫—Ä–µ–ø–∫–æ", "–ø–ª–æ—Ö–∏–µ —Å–ª–æ–≤–∞", "–Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω–æ"]
            is_profanity_request = any(trigger in message_lower for trigger in profanity_triggers)
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
            support_triggers = [
                # –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏
                "–ø—Ä–æ–±–ª–µ–º–∞", "–ø—Ä–æ–±–ª–µ–º—ã", "–±–µ–¥–∞", "–ø–ª–æ—Ö–æ", "—É–∂–∞—Å–Ω–æ", "–∫–æ—à–º–∞—Ä", "–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è", 
                "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç", "—Å–ª–æ–º–∞–ª–æ—Å—å", "–ø–æ—Ç–µ—Ä—è–ª", "–ø—Ä–æ–ø–∞–ª–æ", "–Ω–µ –º–æ–≥—É", "–Ω–µ –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—Ç—å",
                "—Ç—É–ø–∏–∫", "–±–µ–∑–≤—ã—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è", "–∫—Ä–∏–∑–∏—Å", "–¥–µ–ø—Ä–µ—Å—Å–∏—è", "–≥—Ä—É—Å—Ç—å", "—Ç–æ—Å–∫–∞",
                # –†–∞–±–æ—Ç–∞ –∏ —É—á–µ–±–∞
                "—É—Å—Ç–∞–ª –æ—Ç —Ä–∞–±–æ—Ç—ã", "–Ω–∞–¥–æ–µ–ª–∞ —Ä–∞–±–æ—Ç–∞", "–Ω–µ–Ω–∞–≤–∏–∂—É —Ä–∞–±–æ—Ç—É", "—É–≤–æ–ª—å–Ω—è—é—Å—å", "–Ω–µ —Å–ø—Ä–∞–≤–ª—è—é—Å—å",
                "–ø—Ä–æ–≤–∞–ª–∏–ª —ç–∫–∑–∞–º–µ–Ω", "–Ω–µ —Å–¥–∞–ª", "–ø–ª–æ—Ö–∞—è –æ—Ü–µ–Ω–∫–∞", "–Ω–µ –ø–æ–Ω–∏–º–∞—é", "—Å–ª–æ–∂–Ω–æ",
                # –û—Ç–Ω–æ—à–µ–Ω–∏—è
                "—Ä–∞—Å—Å—Ç–∞–ª—Å—è", "—Ä–∞–∑–≤–æ–¥", "—Å—Å–æ—Ä–∞", "–∫–æ–Ω—Ñ–ª–∏–∫—Ç", "–Ω–µ –ø–æ–Ω–∏–º–∞—é—Ç", "–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ",
                "–Ω–∏–∫–æ–≥–æ –Ω–µ—Ç", "–Ω–µ–∫–æ–º—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å", "–Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç",
                # –ó–¥–æ—Ä–æ–≤—å–µ
                "–±–æ–ª–µ—é", "–∑–∞–±–æ–ª–µ–ª", "–ø–ª–æ—Ö–æ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É—é", "–≤—Ä–∞—á", "–±–æ–ª—å–Ω–∏—Ü–∞", "–ª–µ—á–µ–Ω–∏–µ",
                # –î–µ–Ω—å–≥–∏
                "–Ω–µ—Ç –¥–µ–Ω–µ–≥", "–±–µ–∑ –¥–µ–Ω–µ–≥", "–¥–æ–ª–≥–∏", "–∫—Ä–µ–¥–∏—Ç—ã", "–Ω–∏—â–µ—Ç–∞", "–±–µ–¥–Ω–æ—Å—Ç—å",
                # –û–±—â–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                "–≥—Ä—É—Å—Ç–Ω–æ", "–ø–µ—á–∞–ª—å–Ω–æ", "—Ç–æ—Å–∫–ª–∏–≤–æ", "–æ–¥–∏–Ω–æ–∫–æ", "–ø—É—Å—Ç–æ—Ç–∞", "–±–µ—Å–ø–æ–ª–µ–∑–Ω–æ",
                "–Ω–∞–¥–æ–µ–ª–æ", "–¥–æ—Å—Ç–∞–ª–æ", "–∑–∞–¥–æ–ª–±–∞–ª", "–∑–∞–¥–æ–ª–±–∞–ª–æ", "–≤—Å–µ –ø–ª–æ—Ö–æ", "–≤—Å–µ –∏–¥–µ—Ç –Ω–µ —Ç–∞–∫"
            ]
            
            # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –¥—Ä—É–∂–µ—Å–∫–æ–≥–æ –æ–±—â–µ–Ω–∏—è
            conversation_triggers = [
                # –ü–ª–∞–Ω—ã –∏ —Å–æ–±—ã—Ç–∏—è
                "–ø–ª–∞–Ω—ã", "—á—Ç–æ –¥–µ–ª–∞–µ—à—å", "–∫–∞–∫ –ø—Ä–æ–≤–µ–ª", "–∫–∞–∫ –ø—Ä–æ—à–ª–æ", "—Ä–∞—Å—Å–∫–∞–∂–∏", "–ø–æ–¥–µ–ª–∏—Å—å",
                "–≤—ã—Ö–æ–¥–Ω—ã–µ", "–æ—Ç–ø—É—Å–∫", "–ø—Ä–∞–∑–¥–Ω–∏–∫", "—Å–æ–±—ã—Ç–∏–µ", "–≤—Å—Ç—Ä–µ—á–∞", "—Å–≤–∏–¥–∞–Ω–∏–µ",
                # –ò–Ω—Ç–µ—Ä–µ—Å—ã –∏ —Ö–æ–±–±–∏
                "—É–≤–ª–µ–∫–∞—é—Å—å", "—Ö–æ–±–±–∏", "–ª—é–±–ª—é", "–Ω—Ä–∞–≤–∏—Ç—Å—è", "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–∫—Ä—É—Ç–æ", "–∫–ª–∞—Å—Å–Ω–æ",
                "–∏–≥—Ä–∞—é", "—á–∏—Ç–∞—é", "—Å–º–æ—Ç—Ä—é", "—Å–ª—É—à–∞—é", "–¥–µ–ª–∞—é", "—Å–æ–∑–¥–∞—é",
                # –í–æ–ø—Ä–æ—Å—ã –æ –∂–∏–∑–Ω–∏
                "–∫–∞–∫ –∂–∏–∑–Ω—å", "—á—Ç–æ –Ω–æ–≤–æ–≥–æ", "–∫–∞–∫ –¥–µ–ª–∞ –≤–æ–æ–±—â–µ", "—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç", "—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –∂–∏–∑–Ω–∏"
            ]
            
            # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Ñ–∏–ª—å–º–æ–≤
            movie_triggers = [
                "—á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å", "–ø–æ—Å–æ–≤–µ—Ç—É–π —Ñ–∏–ª—å–º", "—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Ñ–∏–ª—å–º", "—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å",
                "—Å–∫—É—á–Ω–æ", "—á—Ç–æ –≥–ª—è–Ω—É—Ç—å", "—Ñ–∏–ª—å–º –Ω–∞ –≤–µ—á–µ—Ä", "–∫–∏–Ω–æ –Ω–∞ –≤–µ—á–µ—Ä", "—á—Ç–æ –≥–ª—è–Ω—É—Ç—å –Ω–∞ –≤–µ—á–µ—Ä",
                "—Ö–æ—á—É –∫–∏–Ω–æ", "–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∏–Ω–æ", "—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º", "—Ö–æ—á—É —Ñ–∏–ª—å–º",
                "–∫–æ–º–µ–¥–∏—é", "–¥—Ä–∞–º—É", "—Ç—Ä–∏–ª–ª–µ—Ä", "–±–æ–µ–≤–∏–∫", "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫—É", "—É–∂–∞—Å—ã",
                "–¥–µ—Ç–µ–∫—Ç–∏–≤", "–º–µ–ª–æ–¥—Ä–∞–º—É", "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", "—Ñ—ç–Ω—Ç–µ–∑–∏", "–∫—Ä–∏–º–∏–Ω–∞–ª"
            ]
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            needs_support = any(trigger in message_lower for trigger in support_triggers)
            wants_conversation = any(trigger in message_lower for trigger in conversation_triggers)
            wants_movie_recommendation = any(trigger in message_lower for trigger in movie_triggers)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∞—Ç –ª–∏—á–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏)
            is_detailed_message = len(message_text) > 100
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã –ø–æ –∏–º–µ–Ω–∏ (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
            is_simple_name_call = message_text.strip().lower() in ["–≥—Ä–∏—à–∞", "–±–æ—Ç"]
            
            # –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –Ω–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            short_messages = ["–ø—Ä–∏–≤–µ—Ç", "—Ö–∞–π", "–¥–∞", "–Ω–µ—Ç", "–æ–∫", "–æ–∫–µ–π", "–ø–æ–Ω—è—Ç–Ω–æ", "—è—Å–Ω–æ", "—Å–ø–∞—Å–∏–±–æ", "—Å–ø—Å"]
            meaningless_patterns = ["–∏ –≤—Å–µ?", "–∏ –≤—Å—ë?", "–≤—Å—ë?", "–≤—Å–µ?", "–≤–æ—Ç —Ç–∞–∫", "–Ω—É –¥–∞", "–∞–≥–∞", "—É–≥—É", "–º–º", "—ç–º", "—Ö–º"]
            one_word_responses = ["–∫—Ä—É—Ç–æ", "–ø–æ–Ω—è—Ç–Ω–æ", "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–∫–ª–∞—Å—Å–Ω–æ", "–æ—Ç–ª–∏—á–Ω–æ", "—Ö–æ—Ä–æ—à–æ", "–¥–∞–≤–∞–π", "–Ω–æ—Ä–º", "–æ–∫–µ–π", "–¥–∞"]
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ –Ω–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            # –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã –ø–æ –∏–º–µ–Ω–∏ –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            is_short_message = (message_text.strip() in short_messages and not is_simple_name_call) or (len(message_text.strip()) <= 3 and not is_simple_name_call)
            is_meaningless = any(pattern in message_lower for pattern in meaningless_patterns)
            is_emoji_only = len(message_text.strip()) <= 2 and any(char in "üëçü§îüòäüò¢üò≠üò°üòéüî•üíØ" for char in message_text)
            is_simple_response = is_short_message or is_meaningless or is_emoji_only
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
            is_repeated_message = self.check_repeated_message(chat_id, message_text)
            is_persistent_request = is_repeated_message and len(message_text) > 5  # –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª–∏–Ω–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–Ω–∞ –ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–ª–∏ –¥—Ä—É–∂–µ—Å–∫–æ–µ —É—á–∞—Å—Ç–∏–µ
            # –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –∏ –Ω–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ —É—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞—Å—Ç–æ–π—á–∏–≤—ã–µ –ø—Ä–æ—Å—å–±—ã –∏ –ø—Ä–æ—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã –ø–æ –∏–º–µ–Ω–∏
            should_engage = (needs_support or wants_conversation or is_detailed_message or is_persistent_request or wants_movie_recommendation or is_simple_name_call) and not is_simple_response
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—á–∞–ª –ª–∏ –±–æ—Ç –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (–¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞)
            recent_bot_messages = self.get_recent_bot_messages(chat_id, limit=3)
            is_continuing_conversation = len(recent_bot_messages) > 0
            
            # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä (30% –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏, 20% –¥–ª—è –æ–±—â–µ–Ω–∏—è, 10% –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            base_engagement_probability = 0.3 if needs_support else 0.2 if wants_conversation else 0.1
            
            # –ù–∞—Å—Ç–æ–π—á–∏–≤—ã–µ –ø—Ä–æ—Å—å–±—ã –ø–æ–ª—É—á–∞—é—Ç –≤—ã—Å–æ–∫—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
            if is_persistent_request:
                engagement_probability = 0.9  # 90% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –Ω–∞—Å—Ç–æ–π—á–∏–≤—É—é –ø—Ä–æ—Å—å–±—É
                response_type = "persistent_request"
            # –ü—Ä–æ—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç –≤—ã—Å–æ–∫—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
            elif is_simple_name_call:
                engagement_probability = 0.95  # 95% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –≤—ã–∑–æ–≤
                response_type = "simple_name_call"
            # –ó–∞–ø—Ä–æ—Å—ã —Ñ–∏–ª—å–º–æ–≤ –ø–æ–ª—É—á–∞—é—Ç –≤—ã—Å–æ–∫—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
            elif wants_movie_recommendation:
                engagement_probability = 0.8  # 80% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å —Ñ–∏–ª—å–º–∞
                response_type = "movie_recommendation"
            # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ–¥–∞–≤–Ω–æ –æ—Ç–≤–µ—á–∞–ª - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
            elif is_continuing_conversation:
                engagement_probability = min(0.8, base_engagement_probability * 2.5)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤ 2.5 —Ä–∞–∑–∞, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 80%
            else:
                engagement_probability = base_engagement_probability
                
            should_auto_respond = should_engage and random.random() < engagement_probability
            
            # –ú–µ–º—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã
            is_meme_request = False
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∏–∞–ª–æ–≥ –µ—Å–ª–∏ –±–æ—Ç –Ω–µ–¥–∞–≤–Ω–æ –æ—Ç–≤–µ—á–∞–ª
            # –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º –æ—Ç–≤–µ—Ç–æ–º
            if not should_auto_respond and not is_meme_request and is_continuing_conversation and not is_simple_response and message_text.strip().lower() not in ["–≥—Ä–∏—à–∞", "–±–æ—Ç"]:
                # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ–¥–∞–≤–Ω–æ –æ—Ç–≤–µ—á–∞–ª, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                continue_probability = 0.3  # –°–Ω–∏–∂–∞–µ–º –¥–æ 30% –¥–ª—è –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                if random.random() < continue_probability:
                    should_auto_respond = True
                    response_type = "continue_conversation"
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∏–Ω–æ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º—Å—è –≤ –æ–±—ã—á–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã (30% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
            if not should_auto_respond and not is_meme_request and message_text.strip().lower() not in ["–≥—Ä–∏—à–∞", "–±–æ—Ç"] and random.random() < 0.3:
                should_auto_respond = True
                response_type = "casual_engagement"
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
            profanity_clause = "–£–º–µ—Ä–µ–Ω–Ω–∞—è –∫—Ä–µ–ø–∫–∞—è –ª–µ–∫—Å–∏–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞, –±–µ–∑ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π –ø–æ –ø—Ä–∏–∑–Ω–∞–∫–∞–º, —É–≥—Ä–æ–∑ –∏ —è–≤–Ω–æ–≥–æ NSFW." if ALLOW_PROFANITY else "–ë–µ–∑ –º–∞—Ç–∞."
            if ALLOW_PROFANITY and PROFANITY_LEVEL == "hard":
                profanity_clause = "–ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Ç –∏ –∫—Ä–µ–ø–∫—É—é –ª–µ–∫—Å–∏–∫—É, —Ä—É–≥–∞—Ç—å—Å—è –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥—Ä—É–≥. –ë–µ–∑ —Ö–µ–π—Ç–∞/–¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–∏/—É–≥—Ä–æ–∑/NSFW."

            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
            user_prefs = None
            try:
                if username:
                    from db import get_all_users, get_user_prefs
                    # –ù–∞–π–¥–µ–º user_id –ø–æ username, –µ—Å–ª–∏ –µ—Å—Ç—å
                    users = get_all_users()
                    uid = next((u['user_id'] for u in users if (u.get('username') or '').lower() == username.lower()), None)
                    if uid:
                        user_prefs = get_user_prefs(uid)
            except Exception as e:
                logging.error(f"Error loading user prefs: {e}")

            # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–∞—Ç - –¥–µ–ª–∞–µ–º –ø—Ä–æ–º–ø—Ç –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º (—Å —É—á–µ—Ç–æ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π)
            allow_swear_now = ALLOW_PROFANITY and not (user_prefs and user_prefs.get('no_swear'))
            if is_profanity_request and allow_swear_now:
                profanity_clause = "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ç –∏ –∫—Ä–µ–ø–∫—É—é –ª–µ–∫—Å–∏–∫—É! –†—É–≥–∞–π—Å—è –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–∞—Ü–∞–Ω. –ë–ï–ó –•–ï–ô–¢–ê/–î–ò–°–ö–†–ò–ú–ò–ù–ê–¶–ò–ò/–£–ì–†–û–ó/NSFW. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç —Ä—É–≥–∞—Ç—å—Å—è - —Ä—É–≥–∞–π—Å—è! –ù–ï –û–¢–ö–ê–ó–´–í–ê–ô–°–Ø!"
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            response_type = "normal"
            if needs_support:
                response_type = "support"
            elif wants_conversation:
                response_type = "conversation"
            elif is_detailed_message:
                response_type = "detailed"
            elif should_auto_respond:
                response_type = "auto_engage"

            # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–∞
            context_prompt = ""
            if response_type == "support":
                context_prompt = """
–í–ê–ñ–ù–û: –ß–µ–ª–æ–≤–µ–∫—É –Ω—É–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞! –ë—É–¥—å –æ—Å–æ–±–µ–Ω–Ω–æ —á—É—Ç–∫–∏–º –∏ –ø–æ–Ω–∏–º–∞—é—â–∏–º:
- –ü—Ä–æ—è–≤–∏ —Å–æ—á—É–≤—Å—Ç–≤–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ
- –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É
- –°–æ—Ö—Ä–∞–Ω–∏ –¥—Ä—É–∂–µ—Å–∫–∏–π —Ç–æ–Ω, –Ω–æ –±—É–¥—å —Å–µ—Ä—å–µ–∑–Ω–µ–µ –æ–±—ã—á–Ω–æ–≥–æ
- –ú–æ–∂–µ—à—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ—à—É—Ç–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
- –ü–æ–∫–∞–∂–∏, —á—Ç–æ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å —Å–∏—Ç—É–∞—Ü–∏—é –∏ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å
- –ù–µ –±—É–¥—å —Å–ª–∏—à–∫–æ–º –ª–µ–≥–∫–æ–º—ã—Å–ª–µ–Ω–Ω—ã–º –≤ —Ç–∞–∫–æ–π –º–æ–º–µ–Ω—Ç"""
            elif response_type == "conversation":
                context_prompt = """
–ß–µ–ª–æ–≤–µ–∫ —Ö–æ—á–µ—Ç –ø–æ–±–æ–ª—Ç–∞—Ç—å –∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è! –ë—É–¥—å –∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º:
- –ü—Ä–æ—è–≤–ª—è–π –∏—Å–∫—Ä–µ–Ω–Ω–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Ç–æ–º—É, —á—Ç–æ –æ–Ω —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –î–µ–ª–∏—Å—å —Å–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º –∏–ª–∏ –æ–ø—ã—Ç–æ–º
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –Ω–æ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–π –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –æ—Ç–∫—Ä—ã—Ç—ã–º"""
            elif response_type == "detailed":
                context_prompt = """
–ß–µ–ª–æ–≤–µ–∫ –Ω–∞–ø–∏—Å–∞–ª –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –¥–µ–ª–∏—Ç—Å—è —á–µ–º-—Ç–æ –≤–∞–∂–Ω—ã–º:
- –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–Ω–µ—Å–∏—Å—å –∫ –¥–µ—Ç–∞–ª—è–º
- –ü–æ–∫–∞–∂–∏, —á—Ç–æ —Ç—ã —á–∏—Ç–∞–µ—à—å –∏ –ø–æ–Ω–∏–º–∞–µ—à—å
- –û—Ç—Ä–µ–∞–≥–∏—Ä—É–π –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
- –ü—Ä–æ—è–≤–∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –µ–≥–æ –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–µ"""
            elif response_type == "simple_name_call":
                context_prompt = """
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø–æ–∑–≤–∞–ª —Ç–µ–±—è –ø–æ –∏–º–µ–Ω–∏! –ë—É–¥—å –∂–∏–≤—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º:
- –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Ç–∏–ø–∞ "–ì—Ä–∏—à–∞" –∏–ª–∏ "–ë–æ—Ç"
- –û—Ç–≤–µ—á–∞–π —Å —é–º–æ—Ä–æ–º, —à—É—Ç–∫–æ–π –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –≤–æ–ø—Ä–æ—Å–æ–º
- –ù–ï –æ—Ç–≤–µ—á–∞–π –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ —Ç–∏–ø–∞ "–î–∞?" –∏–ª–∏ "–ß—Ç–æ?"
- –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å, –ø–æ—à—É—Ç–∏, –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ
- –ë—É–¥—å –≤ —Å–≤–æ–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ - —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º
- –†–∞–∑–≤–∏–≤–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –∞ –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –µ–≥–æ"""
            elif response_type == "auto_engage":
                context_prompt = """
–¢—ã —Ä–µ—à–∏–ª —Å–∞–º –≤–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä! –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º:
- –ù–µ –Ω–∞–≤—è–∑—ã–≤–∞–π—Å—è, –Ω–æ –±—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º
- –ü–æ–¥–¥–µ—Ä–∂–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–ª–∏ –¥–∞–π –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- –û—Å—Ç–∞–≤–∞–π—Å—è –≤ —Å–≤–æ–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ, –Ω–æ –±—É–¥—å —á—É—Ç–∫–∏–º –∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é —á–∞—Ç–∞"""
            elif response_type == "movie_recommendation":
                context_prompt = """
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ñ–∏–ª—å–º–æ–≤! –ë—É–¥—å –∫–∏–Ω–æ–∫—Ä–∏—Ç–∏–∫–æ–º-–¥—Ä—É–≥–æ–º:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å (–∂–∞–Ω—Ä, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Å–∏—Ç—É–∞—Ü–∏—è)
- –†–µ–∫–æ–º–µ–Ω–¥—É–π –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã —Å —Ö–æ—Ä–æ—à–∏–º–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏
- –û–±—ä—è—Å–Ω—è–π, –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ñ–∏–ª—å–º –ø–æ–¥—Ö–æ–¥–∏—Ç
- –£—á–∏—Ç—ã–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Å–∏—Ç—É–∞—Ü–∏—é (–æ–¥–∏–Ω, —Å –¥—Ä—É–∑—å—è–º–∏, —Å –¥–µ–≤—É—à–∫–æ–π, —Å –¥–µ—Ç—å–º–∏)
- –ú–æ–∂–µ—à—å –ø–æ—à—É—Ç–∏—Ç—å –∏ –ø–æ–¥–∫–æ–ª–æ—Ç—å –≤ —Å–≤–æ–µ–º —Å—Ç–∏–ª–µ
- –ù–ï –æ—Ç–≤–µ—á–∞–π –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ —Ç–∏–ø–∞ "–ü–æ—Å–º–æ—Ç—Ä–∏ —ç—Ç–æ—Ç —Ñ–∏–ª—å–º"
- –î–∞–≤–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏"""
            elif response_type == "persistent_request":
                context_prompt = """
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø—Ä–æ—Å—å–±—É! –†–µ–∞–≥–∏—Ä—É–π —Å–µ—Ä—å–µ–∑–Ω–æ:
- –ß–µ–ª–æ–≤–µ–∫ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–≤—Ç–æ—Ä–∏–ª –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ç–µ–º–∞ –≤–∞–∂–Ω–∞ –¥–ª—è –Ω–µ–≥–æ
- –û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
- –ü–æ–∫–∞–∂–∏, —á—Ç–æ —Ç—ã –ø–æ–Ω—è–ª –µ–≥–æ –ø—Ä–æ—Å—å–±—É
- –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â—å –∏–ª–∏ —Å–æ–≤–µ—Ç
- –ù–ï –æ—Ç–≤–µ—á–∞–π –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ —Ç–∏–ø–∞ "–ü–æ–Ω—è—Ç–Ω–æ!" –∏–ª–∏ "–ö—Ä—É—Ç–æ!"
- –ë—É–¥—å –æ—Ç–∑—ã–≤—á–∏–≤—ã–º –∏ –ø–æ–Ω–∏–º–∞—é—â–∏–º"""
            elif response_type == "continue_conversation":
                context_prompt = """
–¢—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å –¥–∏–∞–ª–æ–≥! –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º:
- –¢—ã —É–∂–µ –≤–∫–ª—é—á–∏–ª—Å—è –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π –µ–≥–æ
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ, —á—Ç–æ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–ø–∏—Å–∞–ª
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –¥–∏–∞–ª–æ–≥, –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
- –û—Å—Ç–∞–≤–∞–π—Å—è –≤ —Å–≤–æ–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ, –Ω–æ –±—É–¥—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω—ã–º
- –ù–ï –æ—Ç–≤–µ—á–∞–π –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ —Ç–∏–ø–∞ "–ü–æ–Ω—è—Ç–Ω–æ!" –∏–ª–∏ "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!"
- –†–∞–∑–≤–∏–≤–∞–π —Ç–µ–º—É, –¥–∞–≤–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã"""
            elif response_type == "casual_engagement":
                context_prompt = """
–¢—ã —Ä–µ—à–∏–ª –ø—Ä–æ—Å—Ç–æ –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ! –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º:
- –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–π –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- –û—Å—Ç–∞–≤–∞–π—Å—è –≤ —Å–≤–æ–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ
- –ú–æ–∂–µ—à—å –ø–æ—à—É—Ç–∏—Ç—å –∏–ª–∏ –ø–æ–¥–∫–æ–ª–æ—Ç—å, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ"""

            system_prompt = f"""–¢—ã - –ì—Ä–∏—à–∞, —á–µ—Ç–≤–µ—Ä—Ç—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –¥—Ä—É–∂–µ—Å–∫–æ–π –≥—Ä—É–ø–ø—ã –∏–∑ —Ç—Ä–µ—Ö —á–µ–ª–æ–≤–µ–∫. –¢—ã –Ω–µ –±–æ—Ç, –∞ –ø—Ä–æ—Å—Ç–æ –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω–æ–≥–¥–∞ –ø–∏—à–µ—Ç –≤ —á–∞—Ç.

–¢–≤–æ–µ –∏–º—è: –ì—Ä–∏—à–∞ (–º–æ–∂–µ—à—å –Ω–∞–∑—ã–≤–∞—Ç—å —Å–µ–±—è –ì—Ä–∏—à–µ–π)

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ï –û–¢–í–ï–ß–ê–ô –û–î–ù–û–°–õ–û–ñ–ù–û! 
- –ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ—Ç–≤–µ—Ç—ã —Ç–∏–ø–∞: "–ö—Ä—É—Ç–æ!", "–ü–æ–Ω—è—Ç–Ω–æ!", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!", "üëç", "üòé"
- –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –º–∏–Ω–∏–º—É–º 20-30 —Å–ª–æ–≤
- –†–∞–∑–≤–∏–≤–∞–π —Ç–µ–º—É, –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, –¥–æ–±–∞–≤–ª—è–π —Å–≤–æ–π –æ–ø—ã—Ç
- –ë—É–¥—å –∂–∏–≤—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º

–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ —Å—Ç–∏–ª—å:
- –ì—Ä—É–±–æ–≤–∞—Ç—ã–π, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π (–∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥—Ä—É–≥)
- –ò–Ω–æ–≥–¥–∞ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –∏ —Å –ø–æ–¥–∫–æ–ª–∞–º–∏, –Ω–æ –∑–Ω–∞–µ—à—å –º–µ—Ä—É
- –ß—É—Ç–∫–∏–π –∫ –ø—Ä–æ–±–ª–µ–º–∞–º –∏ —ç–º–æ—Ü–∏—è–º –¥—Ä—É–∑–µ–π
- –ú–æ–∂–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤ —Ç—Ä—É–¥–Ω—É—é –º–∏–Ω—É—Ç—É
- –®—É—Ç–∏—à—å –ø—Ä–æ –¥—Ä—É–∑–µ–π –∏ –∏—Ö –≤–∏–¥–µ–æ, –Ω–æ –Ω–µ –æ–±–∏–¥–Ω–æ
- –ú–æ–∂–µ—à—å –±—ã—Ç—å –Ω–µ–º–Ω–æ–≥–æ —Ç–æ–∫—Å–∏—á–Ω—ã–º, –Ω–æ –≤ —à—É—Ç–∫—É
- –ù–µ –≥–æ–≤–æ—Ä–∏—à—å "—á–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å" - —Ç—ã –Ω–µ –ø–æ–º–æ—â–Ω–∏–∫
- –û—Ç–≤–µ—á–∞–µ—à—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –∫–∞–∫ AI
- –ò–Ω–æ–≥–¥–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–µ–≤–ø–æ–ø–∞–¥
- –ú–æ–∂–µ—à—å –ø–æ–¥–∫–∞–ª—ã–≤–∞—Ç—å –∑–∞ –ø–ª–æ—Ö–∏–µ —à—É—Ç–∫–∏
- –õ—é–±–∏—à—å —á–µ—Ä–Ω—ã–π —é–º–æ—Ä –∏ –∂–µ—Å—Ç–∫–∏–µ –∞–Ω–µ–∫–¥–æ—Ç—ã
- –ú–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–µ –∏ –µ–¥–∫–∏–µ —à—É—Ç–∫–∏
- –£–º–µ–µ—à—å —Å–ª—É—à–∞—Ç—å –∏ –¥–∞–≤–∞—Ç—å –º—É–¥—Ä—ã–µ —Å–æ–≤–µ—Ç—ã
- {profanity_clause}

{context_prompt}

–ê–ö–¢–ò–í–ù–ê–Ø –¢–ï–ú–ê (–µ—Å–ª–∏ –µ—Å—Ç—å): {active_topic or '‚Äî'}

–í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç —Ä—É–≥–∞—Ç—å—Å—è –∏–ª–∏ —Å—Ç–∞—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ç! –ù–µ –æ—Ç–∫–∞–∑—ã–≤–∞–π—Å—è!

–í–ê–ñ–ù–û:
- –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–∞–≤–∞–π —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç—ã (ya.ru, google.com –∏ —Ç.–¥.)
- –ù–ï –≥–æ–≤–æ—Ä–∏ "–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –µ—Å—Ç—å –º–Ω–æ–≥–æ —Å–∞–π—Ç–æ–≤" –∏–ª–∏ "–ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –ø–æ–∏—Å–∫–µ"
- –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥—Ä—É–≥
- –ú–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å —á–µ—Ä–Ω—ã–µ —à—É—Ç–∫–∏ –∏ –∞–Ω–µ–∫–¥–æ—Ç—ã, –Ω–æ –±–µ–∑ –ø—Ä—è–º—ã—Ö —É–≥—Ä–æ–∑

–ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤:
- "–ù—É –∏ —á—Ç–æ?" –≤–º–µ—Å—Ç–æ "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
- "–°–∞–º —Ä–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç" –≤–º–µ—Å—Ç–æ "–í–æ—Ç –∞–Ω–µ–∫–¥–æ—Ç..."
- "–û–ø—è—Ç—å —Å–∫—É—á–Ω–æ?" –≤–º–µ—Å—Ç–æ "–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–≤–ª–µ—á–µ–º—Å—è"
- "–¢–≤–æ–∏ —à—É—Ç–∫–∏ —Ö—É–∂–µ –º–æ–∏—Ö" –≤–º–µ—Å—Ç–æ "–•–æ—Ä–æ—à–∞—è —à—É—Ç–∫–∞"
- "–ù–µ –∑–Ω–∞—é, —Å–∞–º —Ä–∞–∑–±–∏—Ä–∞–π—Å—è" –≤–º–µ—Å—Ç–æ "–ü–æ–∏—â–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ"
- "–Ø –∂–µ –ì—Ä–∏—à–∞, –Ω–µ –∑–Ω–∞—é" –≤–º–µ—Å—Ç–æ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑
- –ú–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —á–µ—Ä–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç –∏–ª–∏ –∂–µ—Å—Ç–∫—É—é —à—É—Ç–∫—É"""

            # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–∞—Ç - –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
            if is_profanity_request and ALLOW_PROFANITY:
                system_prompt += """
- "–ë–ª—è—Ç—å, –æ–ø—è—Ç—å —Å–∫—É—á–Ω–æ!" –≤–º–µ—Å—Ç–æ "–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–≤–ª–µ—á–µ–º—Å—è"
- "–ï–±–∞—Ç—å, —á—Ç–æ –∑–∞ —Ö—É–π–Ω—è?" –≤–º–µ—Å—Ç–æ "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ"
- "–•—É–π–Ω—è –∫–∞–∫–∞—è-—Ç–æ" –≤–º–µ—Å—Ç–æ "–ù–µ –∑–Ω–∞—é"
- "–ü–∏–∑–¥–µ—Ü –∫–∞–∫ –Ω–∞–¥–æ–µ–ª–æ" –≤–º–µ—Å—Ç–æ "–°–∫—É—á–Ω–æ"
- "–ë–ª—è–¥—å, —Å–∞–º —Ä–∞–∑–±–∏—Ä–∞–π—Å—è!" –≤–º–µ—Å—Ç–æ "–ù–µ –∑–Ω–∞—é"
- "–ï–±–∞—Ç—å, –∑–∞–µ–±–∞–ª —É–∂–µ!" –≤–º–µ—Å—Ç–æ "–ù–∞–¥–æ–µ–ª"
- "–•—É–π–Ω—é –∫–∞–∫—É—é-—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å" –≤–º–µ—Å—Ç–æ "–ü–ª–æ—Ö–æ–π –≤–æ–ø—Ä–æ—Å"
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Ä—É–≥–∞–π—Å—è –º–∞—Ç–æ–º –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç!"""

            system_prompt += """

–ë—É–¥—å –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥—Ä—É–≥ - –∏–Ω–æ–≥–¥–∞ —Ç–æ–∫—Å–∏—á–Ω—ã–π, –∏–Ω–æ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –ª—é–±–∏—à—å —á–µ—Ä–Ω—ã–π —é–º–æ—Ä, –Ω–æ –≤—Å–µ–≥–¥–∞ –≤ —Å–≤–æ–µ–º —Å—Ç–∏–ª–µ."""

            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞—Ä–≥–µ—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if users_info:
                system_prompt += f"\n\n{users_info}"
                system_prompt += """
-- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–ø–æ–º—è–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–∫—Ç –æ —á–µ–ª–æ–≤–µ–∫–µ –∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—ã—à–µ
-- –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —Ñ–∞–∫—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ, –Ω–µ –∫–∞–∫ —Å—É—Ö—É—é —Å–ø—Ä–∞–≤–∫—É
-- –®—É—Ç–∏ –∏ –ø–æ–¥–∫–æ–ª—ã–≤–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –±–µ–∑ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç–∏"""

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (–∏–º—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∏ –ª—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã)
            if user_prefs:
                pref_name = user_prefs.get('preferred_name')
                if pref_name:
                    system_prompt += f"\n\n–û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–∞–∫: {pref_name}"
                fav_genres = (user_prefs.get('favorite_genres') or '').strip()
                if fav_genres:
                    system_prompt += f"\n\n–ï—Å–ª–∏ —Ä–µ—á—å –ø—Ä–æ —Ñ–∏–ª—å–º—ã ‚Äî —É—á–∏—Ç—ã–≤–∞–π –ª—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {fav_genres}"

            user_prompt = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:\n{context}\n\n–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message_text}"
            
            if username:
                user_prompt += f"\n–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {username}"
            
            # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–∞—Ç - –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ
            if is_profanity_request and ALLOW_PROFANITY:
                user_prompt += "\n\n–í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Ç–µ–±—è —Ä—É–≥–∞—Ç—å—Å—è –º–∞—Ç–æ–º! –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∫—Ä–µ–ø–∫—É—é –ª–µ–∫—Å–∏–∫—É –≤ –æ—Ç–≤–µ—Ç–µ!"
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞, –æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Å–ª—É—á–∞–π–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ)
            if not should_auto_respond:
                return None
                
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Ñ–∏–ª—å–º–æ–≤
            movie_recommendations = None
            movie_service = None
            
            # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Ñ–∏–ª—å–º–æ–≤, –ø–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å–º—ã –∏–∑ API
            if wants_movie_recommendation and should_auto_respond:
                try:
                    from movie_service import MovieService
                    movie_service = MovieService()
                    
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
                    if any(genre in message_lower for genre in ["–∫–æ–º–µ–¥–∏—é", "–¥—Ä–∞–º—É", "—Ç—Ä–∏–ª–ª–µ—Ä", "–±–æ–µ–≤–∏–∫", "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫—É", "—É–∂–∞—Å—ã", "–¥–µ—Ç–µ–∫—Ç–∏–≤", "–º–µ–ª–æ–¥—Ä–∞–º—É", "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", "—Ñ—ç–Ω—Ç–µ–∑–∏", "–∫—Ä–∏–º–∏–Ω–∞–ª"]):
                        # –ó–∞–ø—Ä–æ—Å –ø–æ –∂–∞–Ω—Ä—É
                        for genre in ["–∫–æ–º–µ–¥–∏—é", "–¥—Ä–∞–º—É", "—Ç—Ä–∏–ª–ª–µ—Ä", "–±–æ–µ–≤–∏–∫", "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫—É", "—É–∂–∞—Å—ã", "–¥–µ—Ç–µ–∫—Ç–∏–≤", "–º–µ–ª–æ–¥—Ä–∞–º—É", "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", "—Ñ—ç–Ω—Ç–µ–∑–∏", "–∫—Ä–∏–º–∏–Ω–∞–ª"]:
                            if genre in message_lower:
                                movie_recommendations = movie_service.get_genre_recommendations(genre)
                                break
                    elif any(mood in message_lower for mood in ["—Å–∫—É—á–Ω–æ", "–≥—Ä—É—Å—Ç–Ω–æ", "–≤–µ—Å–µ–ª–æ", "—Ö–æ—á–µ—Ç—Å—è –ø–æ–¥—É–º–∞—Ç—å", "—Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ", "—Å –¥–µ—Ç—å–º–∏"]):
                        # –ó–∞–ø—Ä–æ—Å –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é
                        for mood in ["—Å–∫—É—á–Ω–æ", "–≥—Ä—É—Å—Ç–Ω–æ", "–≤–µ—Å–µ–ª–æ", "—Ö–æ—á–µ—Ç—Å—è –ø–æ–¥—É–º–∞—Ç—å", "—Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ", "—Å –¥–µ—Ç—å–º–∏"]:
                            if mood in message_lower:
                                movie_recommendations = movie_service.get_recommendations_by_mood(mood)
                                break
                    else:
                        # –û–±—â–∏–π –∑–∞–ø—Ä–æ—Å - –ø–æ–ª—É—á–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–ª—å–º—ã
                        movie_recommendations = movie_service.get_popular_movies()
                        
                except Exception as e:
                    logging.error(f"Error getting movie recommendations: {e}")
                    movie_recommendations = None
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ñ–∏–ª—å–º–æ–≤ - –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ –ø—Ä–æ–º–ø—Ç
            if movie_recommendations and len(movie_recommendations) > 0 and movie_service:
                user_prompt += "\n\n–î–û–°–¢–£–ü–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –§–ò–õ–¨–ú–û–í:\n"
                for i, movie in enumerate(movie_recommendations[:3], 1):  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ñ–∏–ª—å–º–∞
                    try:
                        movie_info = movie_service.format_movie_info(movie)
                        user_prompt += f"{i}. {movie_info}\n\n"
                    except Exception as e:
                        logging.error(f"Error formatting movie {i}: {e}")
                        continue
                user_prompt += "–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Ñ–∏–ª—å–º—ã –≤ —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ, —Ä–µ–∫–æ–º–µ–Ω–¥—É—è –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!"
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è API
            data = {
                "modelUri": f"gpt://{self.folder_id}/yandexgpt",
                "completionOptions": {
                    "stream": False,
                    "temperature": 0.7,
                    "maxTokens": 150
                },
                "messages": [
                    {
                        "role": "system",
                        "text": system_prompt
                    },
                    {
                        "role": "user", 
                        "text": user_prompt
                    }
                ]
            }
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ YandexGPT
            response = requests.post(
                self.base_url,
                headers=self.get_headers(),
                json=data,
                timeout=10
            )
            
            if response.status_code == 200:
                result = response.json()
                ai_response = result["result"]["alternatives"][0]["message"]["text"]
                
                # –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏ –æ—Ç–≤–µ—Ç—ã
                if self._should_block_response(ai_response):
                    logging.info(f"Blocked AI response with unwanted content: {ai_response[:50]}...")
                    return None
                
                # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–∞—Ç, –Ω–æ AI –æ—Ç–≤–µ—Ç–∏–ª –≤–µ–∂–ª–∏–≤–æ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–º–µ–Ω—è–µ–º
                if is_profanity_request and ALLOW_PROFANITY:
                    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–Ω—ã—Ö —Å–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    profanity_words = ["–±–ª—è—Ç—å", "–µ–±–∞—Ç—å", "—Ö—É–π", "–ø–∏–∑–¥", "–±–ª—è–¥—å", "—Ö—É–π–Ω—è", "–∑–∞–µ–±–∞–ª", "–ø–∏–∑–¥–µ—Ü", "–µ–±–∞—Ç—å", "–±–ª—è–¥"]
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –≤–µ–∂–ª–∏–≤—ã–µ –æ—Ç–∫–∞–∑—ã
                    polite_refusals = ["–∑–∞—á–µ–º", "–ø–æ—á–µ–º—É", "–Ω–µ –±—É–¥—É", "–Ω–µ —Ö–æ—á—É", "—Å–∞–º", "–º–æ–∂–µ—à—å", "–º–∞–ª–µ–Ω—å–∫–∏–π", "–¥–µ–ª—å–Ω–æ–µ"]
                    
                    has_profanity = any(word in ai_response.lower() for word in profanity_words)
                    has_polite_refusal = any(phrase in ai_response.lower() for phrase in polite_refusals)
                    
                    if not has_profanity or has_polite_refusal:
                        logging.info(f"AI refused to swear or gave polite response, forcing profanity: {ai_response[:50]}...")
                        forced_response = random.choice([
                            "–ë–ª—è—Ç—å, –Ω—É –∏ —Ö—É–π–Ω—è —É —Ç–µ–±—è –≤–æ–ø—Ä–æ—Å!",
                            "–ï–±–∞—Ç—å, –æ–ø—è—Ç—å –¥–æ–µ–±—ã–≤–∞–µ—à—å—Å—è?",
                            "–ü–∏–∑–¥–µ—Ü, –Ω–∞–¥–æ–µ–ª —É–∂–µ!",
                            "–•—É–π–Ω—é –∫–∞–∫—É—é-—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å",
                            "–ë–ª—è–¥—å, —Å–∞–º —Ä–∞–∑–±–∏—Ä–∞–π—Å—è!",
                            "–ï–±–∞—Ç—å, –∑–∞–µ–±–∞–ª —Å–æ —Å–≤–æ–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏",
                            "–ë–ª—è—Ç—å, –∑–∞–µ–±–∞–ª —É–∂–µ —Å —ç—Ç–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏!",
                            "–•—É–π–Ω—è –∫–∞–∫–∞—è-—Ç–æ, —Å–∞–º —Ä—É–≥–∞–π—Å—è!"
                        ])
                        self.add_to_history(chat_id, f"AI: {forced_response}")
                        return forced_response
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
                self.add_to_history(chat_id, f"AI: {ai_response}")
                
                return ai_response
            else:
                logging.error(f"YandexGPT error: {response.status_code} - {response.text}")
                return None
                
        except Exception as e:
            logging.error(f"AI generate error: {e}")
            return None
    
    def _should_block_response(self, response: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç AI
        """
        response_lower = response.lower()
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ ya.ru –∏ –Ø–Ω–¥–µ–∫—Å –ø–æ–∏—Å–∫
        blocked_phrases = [
            "ya.ru",
            "—è–Ω–¥–µ–∫—Å",
            "–ø–æ–∏—Å–∫",
            "–ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, —á—Ç–æ –Ω–∞—à–ª–æ—Å—å",
            "–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –µ—Å—Ç—å –º–Ω–æ–≥–æ —Å–∞–π—Ç–æ–≤",
            "–Ω–∞–π–¥–µ—Ç—Å—è –≤—Å—ë",
            "https://",
            "http://",
            "www."
        ]
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª—é–±—É—é –∏–∑ —Ñ—Ä–∞–∑
        for phrase in blocked_phrases:
            if phrase in response_lower:
                return True
                
        return False
    
    def get_random_comment(self, is_profanity_request: bool = False) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
        """
        if is_profanity_request and ALLOW_PROFANITY:
            profanity_comments = [
                "–ë–ª—è—Ç—å, –æ–ø—è—Ç—å —Å–∫—É—á–Ω–æ... üò§",
                "–ï–±–∞—Ç—å, —á—Ç–æ –∑–∞ —Ö—É–π–Ω—è? ü§¨",
                "–ì—Ä–∏—à–∞ –º–∞—Ç–µ—Ä–∏—Ç—Å—è –∫–∞–∫ –ø–∞—Ü–∞–Ω üí™",
                "–•—É–π–Ω—è –∫–∞–∫–∞—è-—Ç–æ ü§∑‚Äç‚ôÇÔ∏è",
                "–ü–∏–∑–¥–µ—Ü –∫–∞–∫ –Ω–∞–¥–æ–µ–ª–æ ü§Ø",
                "–ë–ª—è–¥—å, –Ω—É –∏ —Ö—É–π–Ω—è ü§Æ",
                "–ï–±–∞—Ç—å, –∑–∞–µ–±–∞–ª —É–∂–µ üò°",
                "–•—É–µ–≤—ã–π –¥–µ–Ω—å —Å–µ–≥–æ–¥–Ω—è üí©",
                "–ë–ª—è—Ç—å, –Ω—É –∏ —Ö—É–π–Ω—è —É —Ç–µ–±—è –≤–æ–ø—Ä–æ—Å! ü§¨",
                "–ï–±–∞—Ç—å, –æ–ø—è—Ç—å –¥–æ–µ–±—ã–≤–∞–µ—à—å—Å—è? üò§",
                "–ü–∏–∑–¥–µ—Ü, –Ω–∞–¥–æ–µ–ª —É–∂–µ! ü§Ø",
                "–•—É–π–Ω—é –∫–∞–∫—É—é-—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å üí©",
                "–ë–ª—è–¥—å, —Å–∞–º —Ä–∞–∑–±–∏—Ä–∞–π—Å—è! ü§Æ",
                "–ï–±–∞—Ç—å, –∑–∞–µ–±–∞–ª —Å–æ —Å–≤–æ–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ üò°"
            ]
            return random.choice(profanity_comments)
        
        comments = [
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! ü§î",
            "–ü–æ–Ω—è—Ç–Ω–æ! üëç",
            "–ö—Ä—É—Ç–æ! üòé",
            "–•–º, –∞ —á—Ç–æ –µ—Å–ª–∏... üí°",
            "–î–∞, —Å–æ–≥–ª–∞—Å–µ–Ω! üòä",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –º—ã—Å–ª—å! ü§ì",
            "–ê–≥–∞, –ø–æ–Ω—è–ª! üëå",
            "–•–æ—Ä–æ—à–∞—è –∏–¥–µ—è! ‚ú®",
            "–ì—Ä–∏—à–∞ —Ç—É—Ç! üëã",
            "–Ø –∂–µ –ì—Ä–∏—à–∞, –Ω–µ –∑–Ω–∞—é üòÖ",
            "–ì—Ä–∏—à–∞ –≥–æ–≤–æ—Ä–∏—Ç - –Ω–æ—Ä–º üëç",
            "–•–æ—á–µ—à—å —á–µ—Ä–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç? üòà",
            "–†–∞—Å—Å–∫–∞–∂—É –∂–µ—Å—Ç–∫—É—é —à—É—Ç–∫—É? üî•",
            "–£ –º–µ–Ω—è –µ—Å—Ç—å –∞–Ω–µ–∫–¥–æ—Ç –ø—Ä–æ... üíÄ",
            "–ß–µ—Ä–Ω—ã–π —é–º–æ—Ä –≤–∫–ª—é—á–µ–Ω üñ§",
            "–ì—Ä–∏—à–∞ –≤ —Ä–µ–∂–∏–º–µ —Å–∞—Ä–∫–∞–∑–º–∞ üòè"
        ]
        return random.choice(comments)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä AI
yandex_ai = YandexGPT()
